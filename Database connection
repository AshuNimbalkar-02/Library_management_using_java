package com.Library;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.SQLIntegrityConstraintViolationException;
import java.sql.Statement;
import java.util.Scanner;

public class Main {

    public static void main(String[] args) {
        
        // --- Database Connection Details ---
        String url = "jdbc:mysql://localhost:3306/LIBARARY"; // MySQL database name
        String user = "root";                              // MySQL username
        String password = "Ashutosh@02";                          // MySQL password

        Scanner sc = new Scanner(System.in);
        Connection con = null;

        try {
            // 1. Loading the JDBC Driver
            Class.forName("com.mysql.cj.jdbc.Driver");
            
            // 2. Establish the connection
            con = DriverManager.getConnection(url, user, password);
            System.out.println(" Connected to MySQL Database LIBARARY successfully!");

            int choice;
            do {
                System.out.println("\n--- LIBRARY MANAGEMENT MENU ---");
                System.out.println("1. Add New Book (Insert)");
                System.out.println("2. Borrow Book (Update Status)");
                System.out.println("3. Return Book (Make Available)");
                System.out.println("4. View All Books");
                System.out.println("5. Delete Book Record (Permanent)");
                System.out.println("6. Exit");
                System.out.print("Enter your choice: ");
                
                // Input handling for the choice
                if (sc.hasNextInt()) {
                    choice = sc.nextInt();
                } else {
                    System.out.println("Invalid input. Please enter a number.");
                    sc.next(); // Consume the invalid input
                    choice = 0;
                    continue;
                }
                sc.nextLine(); // Consume the newline

                switch (choice) {
                    // --- Case 1: Add New Book (Insert) ---
                    case 1 -> {
                        System.out.print("Enter unique Book ID (INT): ");
                        int bookId = sc.nextInt();
                        sc.nextLine();
                        System.out.print("Enter Book Title: ");
                        String title = sc.nextLine();
                        
                        // SQL to insert a new book. is_borrowed defaults to FALSE, borrower_name defaults to NULL
                        String insert = "INSERT INTO library_books (book_id, title, is_borrowed, borrower_name) VALUES (?, ?, FALSE, NULL)";
                        PreparedStatement ps = con.prepareStatement(insert);
                        ps.setInt(1, bookId);
                        ps.setString(2, title);
                        
                        try {
                            int rows = ps.executeUpdate();
                            if (rows > 0) {
                                System.out.println(" Book '" + title + "' added successfully! âœ…");
                            } else {
                                System.out.println("Failed to add book.");
                            }
                        } catch (SQLIntegrityConstraintViolationException e) {
                            System.out.println(" Error: Book ID " + bookId + " already exists. Please choose a unique ID.");
                        }
                    }

                    // --- Case 2: Borrow Book (Update Status) ---
                    case 2 -> {
                        System.out.print("Enter Book ID to Borrow: ");
                        int bookId = sc.nextInt();
                        sc.nextLine();
                        System.out.print("Enter Borrower's Name: ");
                        String borrower = sc.nextLine();

                        // Only allow borrowing if the book is currently NOT borrowed
                        String update = "UPDATE library_books SET borrower_name = ?, is_borrowed = TRUE WHERE book_id = ? AND is_borrowed = FALSE";
                        PreparedStatement ps = con.prepareStatement(update);
                        ps.setString(1, borrower);
                        ps.setInt(2, bookId);
                        
                        int rows = ps.executeUpdate();
                        if (rows > 0) {
                            System.out.println(" Book " + bookId + " borrowed successfully by " + borrower + "! ðŸ“š");
                        } else {
                            // Check why the update failed (book not found or already borrowed)
                            String check = "SELECT is_borrowed FROM library_books WHERE book_id = ?";
                            PreparedStatement checkPs = con.prepareStatement(check);
                            checkPs.setInt(1, bookId);
                            ResultSet rs = checkPs.executeQuery();
                            
                            if (rs.next() && rs.getBoolean("is_borrowed")) {
                                System.out.println(" Book " + bookId + " is already borrowed.");
                            } else {
                                System.out.println(" Book " + bookId + " not found or is currently unavailable.");
                            }
                        }
                    }

                    // --- Case 3: Return Book (Make Available) ---
                    case 3 -> {
                        System.out.print("Enter Book ID to Return: ");
                        int bookId = sc.nextInt();

                        // Only allow returning if the book is currently borrowed
                        String update = "UPDATE library_books SET borrower_name = NULL, is_borrowed = FALSE WHERE book_id = ? AND is_borrowed = TRUE";
                        PreparedStatement ps = con.prepareStatement(update);
                        ps.setInt(1, bookId);
                        int rows = ps.executeUpdate();
                        
                        System.out.println(rows > 0 ? " Book " + bookId + " returned successfully. Now available. âœ…" : " Book " + bookId + " was not checked out or not found!");
                    }

                    // --- Case 4: View All Books ---
                    case 4 -> {
                        String query = "SELECT book_id, title, borrower_name, is_borrowed FROM library_books ORDER BY book_id";
                        Statement stmt = con.createStatement();
                        ResultSet rs = stmt.executeQuery(query);

                        System.out.println("\n--- Library Book Inventory ---");
                        System.out.printf("%-10s | %-30s | %-12s | %s%n", "ID", "TITLE", "STATUS", "BORROWER");
                        System.out.println("-----------------------------------------------------------------");

                        if (!rs.isBeforeFirst()) {
                            System.out.println("No books in the library.");
                        }
                        
                        while (rs.next()) {
                            int id = rs.getInt("book_id");
                            String title = rs.getString("title");
                            boolean borrowed = rs.getBoolean("is_borrowed");
                            String borrower = rs.getString("borrower_name");

                            String status = borrowed ? "BORROWED" : "Available";
                            String displayBorrower = borrowed ? borrower : "N/A";

                            System.out.printf("%-10d | %-30s | %-12s | %s%n", id, title, status, displayBorrower);
                        }
                        System.out.println("-----------------------------------------------------------------");
                    }

                    // --- Case 5: Delete Book Record (Permanent Removal) ---
                    case 5 -> {
                        System.out.print("Enter Book ID to DELETE (Permanent Removal): ");
                        int bookId = sc.nextInt();

                        String delete = "DELETE FROM library_books WHERE book_id = ?";
                        PreparedStatement ps = con.prepareStatement(delete);
                        ps.setInt(1, bookId);
                        int rows = ps.executeUpdate();
                        
                        System.out.println(rows > 0 ? "Book " + bookId + " record deleted from the system." : " Book not found!");
                    }
                    
                    case 6 -> System.out.println(" Exiting Library Management System... Goodbye!");
                    default -> System.out.println(" Invalid choice! Please enter a number from 1 to 6.");
                }
                
            } while (choice != 6);

        } catch (SQLException e) {
            System.err.println("Database Error occurred: " + e.getMessage());
            e.printStackTrace();
        } catch (ClassNotFoundException e) {
            System.err.println("MySQL JDBC Driver not found. Check your classpath.");
        } catch (Exception e) {
            System.err.println("An unexpected error occurred: " + e.getMessage());
        } finally {
            // Close resources in a finally block
            try {
                if (con != null) {
                    con.close();
                }
                sc.close();
            } catch (SQLException e) {
                System.err.println("Error closing connection: " + e.getMessage());
            }
        }
    }
}
